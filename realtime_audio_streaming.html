<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÆûÊó∂ÊµÅÂºèTTSÈü≥È¢ëÁîüÊàê‰∏éÊí≠Êîæ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .config-section {
            padding: 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .config-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .config-group {
            flex: 1;
            min-width: 200px;
        }

        .config-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .config-group input, .config-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .config-group input:focus, .config-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-section {
            padding: 25px;
        }

        .textarea-container {
            position: relative;
            margin-bottom: 20px;
        }

        #textInput {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }

        #textInput:focus {
            outline: none;
            border-color: #667eea;
        }

        .char-count {
            position: absolute;
            bottom: 10px;
            right: 15px;
            color: #6c757d;
            font-size: 12px;
            background: rgba(255,255,255,0.9);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status-section {
            padding: 25px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-title {
            font-size: 18px;
            font-weight: 600;
            color: #495057;
        }

        .progress-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.3s;
            width: 0%;
        }

        .chunks-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
        }

        .chunk-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.3s;
        }

        .chunk-item:last-child {
            border-bottom: none;
        }

        .chunk-item.processing {
            background-color: #fff3cd;
        }

        .chunk-item.completed {
            background-color: #d4edda;
        }

        .chunk-item.error {
            background-color: #f8d7da;
        }

        .chunk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .chunk-index {
            font-weight: 600;
            color: #495057;
        }

        .chunk-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .chunk-status.processing {
            background: #ffc107;
            color: #856404;
        }

        .chunk-status.completed {
            background: #28a745;
            color: white;
        }

        .chunk-status.error {
            background: #dc3545;
            color: white;
        }

        .chunk-text {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .chunk-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chunk-info {
            font-size: 12px;
            color: #6c757d;
        }

        .play-btn {
            padding: 6px 12px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .play-btn:hover:not(:disabled) {
            background: #138496;
        }

        .play-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .global-audio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }

        .queue-status {
            background: rgba(0, 123, 255, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #007bff;
            border: 1px solid rgba(0, 123, 255, 0.2);
        }

        .input-hint {
            font-size: 11px;
            color: #6c757d;
            margin-top: 4px;
            font-style: italic;
        }

        .api-key-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
        }

        .api-key-toggle:hover {
            color: #495057;
        }

        .config-group {
            position: relative;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-slider {
            width: 100px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .processing .chunk-status {
            animation: pulse 1.5s infinite;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .config-row {
                flex-direction: column;
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ ÂÆûÊó∂ÊµÅÂºèTTSÈü≥È¢ëÁîüÊàê</h1>
            <p>Êô∫ËÉΩÊñáÊú¨ÂàÜÂâ≤ ¬∑ ÂÆûÊó∂Èü≥È¢ëÁîüÊàê ¬∑ ÊµÅÂºèÊí≠Êîæ‰ΩìÈ™å</p>
        </div>

        <div class="main-panel">
            <!-- ÈÖçÁΩÆÂå∫Âüü -->
            <div class="config-section">
                <div class="config-row">
                    <div class="config-group">
                        <label for="serverUrl">ÊúçÂä°Âô®Âú∞ÂùÄ</label>
                        <input type="text" id="serverUrl" value="http://152.136.168.63:11996" placeholder="http://152.136.168.63:11996">
                    </div>
                    <div class="config-group">
                        <label for="apiKey">API ÂØÜÈí• üîê</label>
                        <input type="password" id="apiKey" value="app-Tkgxa5UdOv1FXeBXyEsFQSi5" placeholder="ËØ∑ËæìÂÖ• API Key" required>
                        <button type="button" class="api-key-toggle" id="toggleApiKey" title="ÊòæÁ§∫/ÈöêËóèAPIÂØÜÈí•">üëÅÔ∏è</button>
                        <div class="input-hint">Áî®‰∫éÈ™åËØÅAPIËÆøÈóÆÊùÉÈôêÁöÑÂØÜÈí•</div>
                    </div>
                    <div class="config-group">
                        <label for="audioPath">Èü≥È¢ëÊ†∑Êú¨ÈÄâÊã©</label>
                        <select id="audioPath">
                            <option value="1_oral5.wav">1_oral5.wav</option>
                            <option value="2_oral5.wav">2_oral5.wav</option>
                            <option value="3_oral5.wav">3_oral5.wav</option>
                            <option value="4_oral5.wav">4_oral5.wav</option>
                            <option value="5_oral5.wav">5_oral5.wav</option>
                            <option value="6_oral5.wav">6_oral5.wav</option>
                            <option value="7_oral5.wav">7_oral5.wav</option>
                            <option value="8_oral5.wav">8_oral5.wav</option>
                            <option value="9_oral5.wav">9_oral5.wav</option>
                            <option value="10_oral5.wav">10_oral5.wav</option>
                            <option value="11_oral5.wav">11_oral5.wav</option>
                            <option value="12_oral5.wav">12_oral5.wav</option>
                            <option value="13_oral5.wav">13_oral5.wav</option>
                            <option value="14_oral5.wav">14_oral5.wav</option>
                            <option value="15_oral5.wav">15_oral5.wav</option>
                            <option value="16_oral5.wav">16_oral5.wav</option>
                            <option value="17_oral5.wav">17_oral5.wav</option>
                            <option value="18_oral5.wav">18_oral5.wav</option>
                            <option value="19_oral5.wav">19_oral5.wav</option>
                            <option value="20_oral5.wav">20_oral5.wav</option>
                            <option value="44_1d5fadf24e00d759.wav">44_1d5fadf24e00d759.wav</option>
                            <option value="jay_promptvn.wav">jay_promptvn.wav</option>
                            <option value="sample_prompt.wav" selected>sample_prompt.wav</option>
                            <option value="vo_card_klee_endOfGame_fail_01.wav">vo_card_klee_endOfGame_fail_01.wav</option>
                        </select>
                    </div>
                </div>
                
                <div class="config-row">
                    <div class="config-group">
                        <label for="chunkSize">ÂàÜÂùóÂ§ßÂ∞è <small style="color: #6c757d;">(Â∑≤Á¶ÅÁî®Ôºå‰ªÖÊåâÊ†áÁÇπÂàÜÂâ≤)</small></label>
                        <input type="number" id="chunkSize" value="100" min="20" max="500" disabled title="ÂΩìÂâçÁâàÊú¨‰ªÖÊîØÊåÅÊåâÊ†áÁÇπÁ¨¶Âè∑ÂàÜÂâ≤ÊñáÊú¨">
                    </div>
                    <div class="config-group">
                        <label for="seed">ÈöèÊú∫ÁßçÂ≠ê</label>
                        <input type="number" id="seed" value="8" min="1" max="100">
                    </div>
                    <div class="config-group">
                        <label for="customPunctuation">Ëá™ÂÆö‰πâÂàÜÂâ≤Á¨¶</label>
                        <input type="text" id="customPunctuation" placeholder="‰æãÂ¶Ç: ÔºöÔºå„ÄÇÔºÅÔºü" title="ÊîØÊåÅÂ§ö‰∏™Ê†áÁÇπÁ¨¶Âè∑ÔºåÂ¶ÇËæìÂÖ•'ÔºöÔºå'Ë°®Á§∫ÈÅáÂà∞ÂÜíÂè∑ÊàñÈÄóÂè∑ÈÉΩ‰ºöÂàÜÂâ≤„ÄÇÁïôÁ©∫‰ΩøÁî®ÈªòËÆ§Ê†áÁÇπÁ¨¶Âè∑">
                        <div class="input-hint">ÊîØÊåÅÂ§öÊ†áÁÇπÁ¨¶Âè∑ÔºåÂ¶Ç"ÔºöÔºå"Ë°®Á§∫ÈÅáÂà∞ÂÜíÂè∑ÊàñÈÄóÂè∑ÈÉΩÂàÜÂâ≤</div>
                    </div>
                </div>
            </div>

            <!-- ÊñáÊú¨ËæìÂÖ•Âå∫Âüü -->
            <div class="input-section">
                <div class="textarea-container">
                    <textarea 
                        id="textInput" 
                        placeholder="Âú®ËøôÈáåËæìÂÖ•Ë¶ÅËΩ¨Êç¢‰∏∫ËØ≠Èü≥ÁöÑÊñáÊú¨ÂÜÖÂÆπ...&#10;&#10;ÊîØÊåÅ‰∏≠ÊñáÂíåËã±ÊñáÔºåÁ≥ªÁªü‰ºöËá™Âä®ÊåâÊ†áÁÇπÁ¨¶Âè∑ÂàÜÂâ≤ÊñáÊú¨Âπ∂ÈÄêÂùóÁîüÊàêÈü≥È¢ë„ÄÇ"
                    ></textarea>
                    <div class="char-count">
                        Â≠óÁ¨¶Êï∞: <span id="charCount">0</span>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="btn btn-primary" id="startBtn">üöÄ ÂºÄÂßãÊµÅÂºèÁîüÊàê</button>
                    <button class="btn btn-secondary" id="playAllBtn" disabled>üéµ Êí≠ÊîæÂÖ®ÈÉ®</button>
                    <button class="btn btn-secondary" id="pauseAllBtn" disabled>‚è∏Ô∏è ÊöÇÂÅúÊí≠Êîæ</button>
                    <button class="btn btn-secondary" id="downloadBtn" disabled>üíæ ‰∏ãËΩΩÂêàÊàêÈü≥È¢ë</button>
                    <button class="btn btn-danger" id="stopBtn" disabled>‚èπÔ∏èÂÅúÊ≠¢ÁîüÊàê</button>
                </div>
            </div>

            <!-- Áä∂ÊÄÅÊòæÁ§∫Âå∫Âüü -->
            <div class="status-section">
                <div class="status-header">
                    <div class="status-title">üìä ÁîüÊàêÁä∂ÊÄÅ</div>
                    <div id="statusText">Á≠âÂæÖÂºÄÂßã...</div>
                </div>

                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>

                <!-- ÂÖ®Â±ÄÈü≥È¢ëÊéßÂà∂ -->
                <div class="global-audio-controls">
                    <div class="volume-control">
                        <label for="volumeSlider">üîä Èü≥Èáè:</label>
                        <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.1" value="0.8">
                        <span id="volumeValue">80%</span>
                    </div>
                    <label>
                        <input type="checkbox" id="autoPlay" checked> Ëá™Âä®Êí≠Êîæ
                    </label>
                    <div class="queue-status" id="queueStatus" style="display: none;">
                        ÈòüÂàó: <span id="queueCount">0</span>
                    </div>
                </div>

                <!-- Èü≥È¢ëÁâáÊÆµÂàóË°® -->
                <div class="chunks-container" id="chunksContainer">
                    <div style="padding: 40px; text-align: center; color: #6c757d;">
                        üéµ Èü≥È¢ëÁâáÊÆµÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫
                    </div>
                </div>

                <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalChunks">0</div>
                        <div class="stat-label">ÊÄªÁâáÊÆµÊï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completedChunks">0</div>
                        <div class="stat-label">Â∑≤ÂÆåÊàê</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalTime">0s</div>
                        <div class="stat-label">ÊÄªËÄóÊó∂</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalSize">0KB</div>
                        <div class="stat-label">Èü≥È¢ëÂ§ßÂ∞è</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class StreamingTTSClient {
            constructor() {
                this.isStreaming = false;
                this.eventSource = null;
                this.audioChunks = [];
                this.startTime = null;
                this.totalSize = 0;
                this.currentPlayingIndex = -1;
                this.audioQueue = [];
                this.playbackQueue = []; // Êí≠ÊîæÈòüÂàóÔºåÂ≠òÂÇ®Á≠âÂæÖÊí≠ÊîæÁöÑÁâáÊÆµÁ¥¢Âºï
                this.isPlayingSequence = false; // ÊòØÂê¶Ê≠£Âú®È°∫Â∫èÊí≠Êîæ
                this.globalVolume = 0.8;
                
                this.initializeElements();
                this.bindEvents();
            }

            initializeElements() {
                // ÈÖçÁΩÆÂÖÉÁ¥†
                this.serverUrlInput = document.getElementById('serverUrl');
                this.apiKeyInput = document.getElementById('apiKey');
                this.audioPathInput = document.getElementById('audioPath');
                this.chunkSizeInput = document.getElementById('chunkSize');
                this.seedInput = document.getElementById('seed');
                this.customPunctuationInput = document.getElementById('customPunctuation');
                
                // ÊñáÊú¨ËæìÂÖ•
                this.textInput = document.getElementById('textInput');
                this.charCountSpan = document.getElementById('charCount');
                
                // ÊéßÂà∂ÊåâÈíÆ
                this.startBtn = document.getElementById('startBtn');
                this.playAllBtn = document.getElementById('playAllBtn');
                this.pauseAllBtn = document.getElementById('pauseAllBtn');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.stopBtn = document.getElementById('stopBtn');
                
                // Áä∂ÊÄÅÊòæÁ§∫
                this.statusText = document.getElementById('statusText');
                this.progressBar = document.getElementById('progressBar');
                this.chunksContainer = document.getElementById('chunksContainer');
                
                // ÁªüËÆ°‰ø°ÊÅØ
                this.totalChunksSpan = document.getElementById('totalChunks');
                this.completedChunksSpan = document.getElementById('completedChunks');
                this.totalTimeSpan = document.getElementById('totalTime');
                this.totalSizeSpan = document.getElementById('totalSize');
                
                // Èü≥È¢ëÊéßÂà∂
                this.volumeSlider = document.getElementById('volumeSlider');
                this.volumeValue = document.getElementById('volumeValue');
                this.autoPlayCheckbox = document.getElementById('autoPlay');
                this.queueStatus = document.getElementById('queueStatus');
                this.queueCount = document.getElementById('queueCount');
            }

            bindEvents() {
                // ÊñáÊú¨ËæìÂÖ•Â≠óÁ¨¶ËÆ°Êï∞
                this.textInput.addEventListener('input', () => {
                    this.charCountSpan.textContent = this.textInput.value.length;
                });

                // ÊéßÂà∂ÊåâÈíÆ
                this.startBtn.addEventListener('click', () => this.startStreaming());
                this.playAllBtn.addEventListener('click', () => this.playAllChunks());
                this.pauseAllBtn.addEventListener('click', () => this.pauseAllChunks());
                this.downloadBtn.addEventListener('click', () => this.downloadMergedAudio());
                this.stopBtn.addEventListener('click', () => this.stopStreaming());

                // Èü≥ÈáèÊéßÂà∂
                this.volumeSlider.addEventListener('input', () => {
                    this.globalVolume = parseFloat(this.volumeSlider.value);
                    this.volumeValue.textContent = Math.round(this.globalVolume * 100) + '%';
                    
                    // Êõ¥Êñ∞ÊâÄÊúâÈü≥È¢ëÂÖÉÁ¥†ÁöÑÈü≥Èáè
                    this.audioQueue.forEach(audio => {
                        if (audio.audio) {
                            audio.audio.volume = this.globalVolume;
                        }
                    });
                });

                // ÂàùÂßãÂåñÂ≠óÁ¨¶ËÆ°Êï∞
                this.charCountSpan.textContent = this.textInput.value.length;
                
                // API Key ÊòæÁ§∫/ÈöêËóèÂàáÊç¢
                const toggleApiKeyBtn = document.getElementById('toggleApiKey');
                toggleApiKeyBtn.addEventListener('click', () => {
                    const apiKeyInput = this.apiKeyInput;
                    if (apiKeyInput.type === 'password') {
                        apiKeyInput.type = 'text';
                        toggleApiKeyBtn.textContent = 'üôà'; // ÈöêËóèÂõæÊ†á
                        toggleApiKeyBtn.title = 'ÈöêËóèAPIÂØÜÈí•';
                    } else {
                        apiKeyInput.type = 'password';
                        toggleApiKeyBtn.textContent = 'üëÅÔ∏è'; // ÊòæÁ§∫ÂõæÊ†á
                        toggleApiKeyBtn.title = 'ÊòæÁ§∫APIÂØÜÈí•';
                    }
                });
            }

            async startStreaming() {
                const text = this.textInput.value.trim();
                if (!text) {
                    alert('ËØ∑ËæìÂÖ•Ë¶ÅËΩ¨Êç¢ÁöÑÊñáÊú¨');
                    return;
                }

                const serverUrl = this.serverUrlInput.value.trim();
                const apiKey = this.apiKeyInput.value.trim();
                const selectedAudioFile = this.audioPathInput.value.trim();
                const audioPath = `/opt/notebook/data/TTS/index-tts-vllm-master/assets/${selectedAudioFile}`;
                
                if (!serverUrl || !selectedAudioFile || !apiKey) {
                    alert('ËØ∑Â°´ÂÜôÊúçÂä°Âô®Âú∞ÂùÄ„ÄÅAPIÂØÜÈí•Âπ∂ÈÄâÊã©Èü≥È¢ëÊ†∑Êú¨');
                    return;
                }

                // ÈáçÁΩÆÁä∂ÊÄÅ
                this.resetState();
                this.isStreaming = true;
                this.startTime = Date.now();

                // Êõ¥Êñ∞UIÁä∂ÊÄÅ
                this.updateButtonStates(true);
                this.statusText.textContent = 'Ê≠£Âú®ËøûÊé•ÊúçÂä°Âô®...';

                try {
                    // ÂáÜÂ§áËØ∑Ê±ÇÊï∞ÊçÆ
                    const requestData = {
                        text: text,
                        audio_paths: [audioPath],
                        seed: parseInt(this.seedInput.value) || 8,
                        custom_punctuation: this.customPunctuationInput.value.trim() || null
                    };

                    // ÂèëËµ∑ÊµÅÂºèËØ∑Ê±Ç
                    const response = await fetch(`${serverUrl}/tts_streaming`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': apiKey
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    // Â§ÑÁêÜÊµÅÂºèÂìçÂ∫î
                    await this.handleStreamResponse(response);

                } catch (error) {
                    console.error('ÊµÅÂºèËØ∑Ê±ÇÂ§±Ë¥•:', error);
                    let errorMessage = error.message;
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØAPIÂØÜÈí•ÈîôËØØ
                    if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                        errorMessage = 'APIÂØÜÈí•È™åËØÅÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÂØÜÈí•ÊòØÂê¶Ê≠£Á°Æ üîë';
                    } else if (error.message.includes('403') || error.message.includes('Forbidden')) {
                        errorMessage = 'APIËÆøÈóÆË¢´ÊãíÁªùÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ ‚ö†Ô∏è';
                    }
                    
                    this.statusText.textContent = `‚ùå ÈîôËØØ: ${errorMessage}`;
                    this.updateButtonStates(false);
                    this.isStreaming = false;
                }
            }

            async handleStreamResponse(response) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                try {
                    while (this.isStreaming) {
                        const { done, value } = await reader.read();
                        
                        if (done) {
                            // Â§ÑÁêÜÂâ©‰ΩôÁºìÂÜ≤Âå∫Êï∞ÊçÆ
                            if (buffer.trim()) {
                                await this.processSSEEvent(buffer.trim());
                            }
                            break;
                        }

                        // Ëß£Á†ÅÊï∞ÊçÆÂùóÂπ∂Ê∑ªÂä†Âà∞ÁºìÂÜ≤Âå∫
                        buffer += decoder.decode(value, { stream: true });
                        
                        // Â§ÑÁêÜÂÆåÊï¥ÁöÑSSE‰∫ã‰ª∂Ôºà‰ª•ÂèåÊç¢Ë°åÁ¨¶ÂàÜÂâ≤Ôºâ
                        while (buffer.includes('\n\n')) {
                            const eventEnd = buffer.indexOf('\n\n');
                            const eventData = buffer.substring(0, eventEnd);
                            buffer = buffer.substring(eventEnd + 2);
                            
                            await this.processSSEEvent(eventData);
                        }
                    }
                } finally {
                    reader.releaseLock();
                }
            }

            async processSSEEvent(eventData) {
                const lines = eventData.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const jsonStr = line.slice(6).trim();
                            if (jsonStr && jsonStr !== '') {
                                const data = JSON.parse(jsonStr);
                                await this.handleStreamEvent(data);
                            }
                        } catch (e) {
                            console.warn('Ëß£ÊûêSSE‰∫ã‰ª∂Â§±Ë¥•:', e.message);
                            console.log('Event data:', eventData.slice(0, 500) + '...');
                        }
                        break; // ÊØè‰∏™‰∫ã‰ª∂Âè™Â§ÑÁêÜ‰∏Ä‰∏™dataË°å
                    }
                }
            }

            async handleStreamEvent(data) {
                switch (data.type) {
                    case 'start':
                        this.handleStartEvent(data);
                        break;
                    case 'chunk_start':
                        this.handleChunkStartEvent(data);
                        break;
                    case 'audio':
                        await this.handleAudioEvent(data);
                        break;
                    case 'complete':
                        this.handleCompleteEvent(data);
                        break;
                    case 'error':
                        this.handleErrorEvent(data);
                        break;
                }
            }

            handleStartEvent(data) {
                this.statusText.textContent = `ÂºÄÂßãÁîüÊàê ${data.total_chunks} ‰∏™Èü≥È¢ëÁâáÊÆµ`;
                this.totalChunksSpan.textContent = data.total_chunks;
                
                // Ê∏ÖÁ©∫ÁâáÊÆµÂÆπÂô®Âπ∂ÂàõÂª∫ÁâáÊÆµÂÖÉÁ¥†
                this.chunksContainer.innerHTML = '';
                
                // ÈáçÁΩÆÊí≠ÊîæÁä∂ÊÄÅÂíåÈòüÂàó
                this.currentPlayingIndex = -1;
                this.isPlayingSequence = false;
                this.playbackQueue = [];
                
                data.chunks.forEach((chunkText, index) => {
                    this.createChunkElement(index, chunkText);
                });
            }

            handleChunkStartEvent(data) {
                this.statusText.textContent = `Ê≠£Âú®ÁîüÊàêÁâáÊÆµ ${data.chunk_index + 1}/${data.total_chunks}`;
                this.updateChunkStatus(data.chunk_index, 'processing', 'Â§ÑÁêÜ‰∏≠');
            }

            async handleAudioEvent(data) {
                const chunkIndex = data.chunk_index;
                const audioB64 = data.data;
                const processingTime = data.processing_time;
                const size = data.size;

                try {
                    // Ëß£Á†ÅÈü≥È¢ëÊï∞ÊçÆ
                    const audioBytes = this.base64ToArrayBuffer(audioB64);
                    const audioBlob = new Blob([audioBytes], { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);

                    // ÂàõÂª∫Èü≥È¢ëÂÖÉÁ¥†
                    const audio = new Audio(audioUrl);
                    audio.volume = this.globalVolume;

                    // Â≠òÂÇ®Èü≥È¢ë‰ø°ÊÅØ
                    this.audioQueue[chunkIndex] = {
                        audio: audio,
                        blob: audioBlob,
                        url: audioUrl,
                        size: size,
                        processingTime: processingTime
                    };

                    // Êõ¥Êñ∞ÁâáÊÆµÁä∂ÊÄÅ
                    this.updateChunkStatus(chunkIndex, 'completed', 'Â∑≤ÂÆåÊàê');
                    this.updateChunkInfo(chunkIndex, size, processingTime);

                    // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                    this.totalSize += size;
                    this.completedChunksSpan.textContent = parseInt(this.completedChunksSpan.textContent) + 1;
                    this.totalSizeSpan.textContent = (this.totalSize / 1024).toFixed(1) + 'KB';

                    // Êõ¥Êñ∞ËøõÂ∫¶
                    const totalChunks = parseInt(this.totalChunksSpan.textContent);
                    const completedChunks = parseInt(this.completedChunksSpan.textContent);
                    const progress = (completedChunks / totalChunks) * 100;
                    this.progressBar.style.width = progress + '%';

                    // Ëá™Âä®Êí≠ÊîæÈòüÂàóÁÆ°ÁêÜ
                    if (this.autoPlayCheckbox.checked) {
                        console.log(`[AutoPlay] ÁâáÊÆµ ${chunkIndex} ÁîüÊàêÂÆåÊàêÔºåÂΩìÂâçÊí≠Êîæ: ${this.currentPlayingIndex}, Êí≠ÊîæÂ∫èÂàó: ${this.isPlayingSequence}, ÈòüÂàó: [${this.playbackQueue.join(',')}]`);
                        this.handleAutoPlay(chunkIndex);
                    }

                } catch (error) {
                    console.error('Â§ÑÁêÜÈü≥È¢ëÊï∞ÊçÆÂ§±Ë¥•:', error);
                    this.updateChunkStatus(chunkIndex, 'error', 'ÈîôËØØ');
                }
            }

            handleCompleteEvent(data) {
                this.statusText.textContent = `‚úÖ ÁîüÊàêÂÆåÊàêÔºÅÂÖ± ${data.total_chunks} ‰∏™ÁâáÊÆµ`;
                this.updateButtonStates(false);
                this.playAllBtn.disabled = false;
                this.downloadBtn.disabled = false; // ÂêØÁî®‰∏ãËΩΩÊåâÈíÆ
                this.isStreaming = false;

                // Êõ¥Êñ∞ÊÄªËÄóÊó∂
                const totalTime = (Date.now() - this.startTime) / 1000;
                this.totalTimeSpan.textContent = totalTime.toFixed(1) + 's';
            }

            handleErrorEvent(data) {
                console.error('Èü≥È¢ëÁîüÊàêÈîôËØØ:', data);
                this.updateChunkStatus(data.chunk_index, 'error', 'ÈîôËØØ');
                this.statusText.textContent = `‚ùå ÁâáÊÆµ ${data.chunk_index + 1} ÁîüÊàêÂ§±Ë¥•`;
            }

            createChunkElement(index, text) {
                const chunkDiv = document.createElement('div');
                chunkDiv.className = 'chunk-item';
                chunkDiv.id = `chunk-${index}`;

                chunkDiv.innerHTML = `
                    <div class="chunk-header">
                        <div class="chunk-index">ÁâáÊÆµ ${index + 1}</div>
                        <div class="chunk-status" id="status-${index}">Á≠âÂæÖ‰∏≠</div>
                    </div>
                    <div class="chunk-text">${text}</div>
                    <div class="chunk-controls">
                        <button class="play-btn" id="play-${index}" onclick="client.playChunk(${index})" disabled>
                            ‚ñ∂Ô∏è Êí≠Êîæ
                        </button>
                        <div class="chunk-info" id="info-${index}">-</div>
                    </div>
                `;

                this.chunksContainer.appendChild(chunkDiv);
            }

            updateChunkStatus(index, status, text) {
                const chunkElement = document.getElementById(`chunk-${index}`);
                const statusElement = document.getElementById(`status-${index}`);

                if (chunkElement && statusElement) {
                    // Êõ¥Êñ∞Á±ªÂêç
                    chunkElement.className = `chunk-item ${status}`;
                    statusElement.className = `chunk-status ${status}`;
                    statusElement.textContent = text;

                    // Â¶ÇÊûúÂÆåÊàêÔºåÂêØÁî®Êí≠ÊîæÊåâÈíÆ
                    if (status === 'completed') {
                        const playBtn = document.getElementById(`play-${index}`);
                        if (playBtn) {
                            playBtn.disabled = false;
                        }
                    }
                }
            }

            updateChunkInfo(index, size, processingTime) {
                const infoElement = document.getElementById(`info-${index}`);
                if (infoElement) {
                    infoElement.textContent = `${(size / 1024).toFixed(1)}KB ¬∑ ${processingTime.toFixed(2)}s`;
                }
            }

            playChunk(index) {
                const audioInfo = this.audioQueue[index];
                if (!audioInfo || !audioInfo.audio) {
                    return;
                }

                // ÂÅúÊ≠¢ÂÖ∂‰ªñÊ≠£Âú®Êí≠ÊîæÁöÑÈü≥È¢ëÔºà‰ΩÜ‰∏çÈáçÁΩÆÊí≠ÊîæÁä∂ÊÄÅÔºâ
                this.pauseAllAudioOnly();

                // Êí≠ÊîæÂΩìÂâçÈü≥È¢ë
                this.currentPlayingIndex = index;
                
                // Ê∏ÖÁêÜ‰πãÂâçÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÈÅøÂÖçÈáçÂ§çÁªëÂÆö
                audioInfo.audio.onended = null;
                
                // ÈáçÊñ∞ÁªëÂÆöÊí≠ÊîæÁªìÊùü‰∫ã‰ª∂
                audioInfo.audio.onended = () => {
                    this.onChunkPlaybackComplete();
                };
                
                audioInfo.audio.play().catch(error => {
                    console.error('Êí≠ÊîæÈü≥È¢ëÂ§±Ë¥•:', error);
                    this.onChunkPlaybackComplete();
                });
            }

            // Â§ÑÁêÜÈü≥È¢ëÊí≠ÊîæÂÆåÊàê
            onChunkPlaybackComplete() {
                console.log(`[AutoPlay] Êí≠ÊîæÂÆåÊàêÔºåÈòüÂàóÈïøÂ∫¶: ${this.playbackQueue.length}, ÊòØÂê¶ÊµÅÂºèÁîüÊàê: ${this.isStreaming}`);
                this.currentPlayingIndex = -1;
                
                // Â¶ÇÊûúÂêØÁî®‰∫ÜËá™Âä®Êí≠Êîæ‰∏îÊ≠£Âú®È°∫Â∫èÊí≠Êîæ
                if (this.isPlayingSequence && this.autoPlayCheckbox.checked) {
                    if (this.playbackQueue.length > 0) {
                        // Êí≠ÊîæÈòüÂàó‰∏≠ÁöÑ‰∏ã‰∏Ä‰∏™ÁâáÊÆµ
                        const nextIndex = this.getNextChunkToPlay();
                        if (nextIndex !== -1) {
                            console.log(`[AutoPlay] ÁªßÁª≠Êí≠ÊîæÈòüÂàó‰∏≠ÁöÑÁâáÊÆµ ${nextIndex}ÔºåÂΩìÂâçÈòüÂàó: [${this.playbackQueue.join(',')}]`);
                            const indexInQueue = this.playbackQueue.indexOf(nextIndex);
                            console.log(`[AutoPlay] ‰ªéÈòüÂàó‰∏≠ÁßªÈô§ÁâáÊÆµ ${nextIndex}Ôºå‰ΩçÁΩÆ: ${indexInQueue}`);
                            this.playbackQueue.splice(indexInQueue, 1);
                            console.log(`[AutoPlay] ÁßªÈô§ÂêéÈòüÂàó: [${this.playbackQueue.join(',')}]`);
                            this.updateQueueStatus();
                            setTimeout(() => this.playChunk(nextIndex), 100);
                        }
                    } else {
                        // ÈòüÂàó‰∏∫Á©∫ÔºåÊ£ÄÊü•ÊòØÂê¶ËøòÊúâÊú™ÁîüÊàêÁöÑÁâáÊÆµÈúÄË¶ÅÁ≠âÂæÖ
                        if (!this.isStreaming) {
                            // ‰∏çÂú®ÁîüÊàê‰∏≠ÔºåÁªìÊùüÊí≠ÊîæÂ∫èÂàó
                            console.log(`[AutoPlay] ÁîüÊàêÂÆåÊàê‰∏îÈòüÂàó‰∏∫Á©∫ÔºåÁªìÊùüÊí≠ÊîæÂ∫èÂàó üéâ`);
                            this.isPlayingSequence = false;
                            this.updateQueueStatus();
                        } else {
                            // ËøòÂú®ÁîüÊàê‰∏≠Ôºå‰øùÊåÅÊí≠ÊîæÂ∫èÂàóÁä∂ÊÄÅÔºåÁ≠âÂæÖÊñ∞ÁöÑÁâáÊÆµ
                            console.log(`[AutoPlay] ËøòÂú®ÁîüÊàê‰∏≠ÔºåÁ≠âÂæÖÊñ∞ÁâáÊÆµ ‚è≥`);
                            this.updateQueueStatus();
                        }
                    }
                } else {
                    // ‰∏çÊòØËá™Âä®Êí≠ÊîæÊ®°ÂºèÊàñ‰∏çÂú®Êí≠ÊîæÂ∫èÂàó‰∏≠
                    this.isPlayingSequence = false;
                    this.updateQueueStatus();
                }
            }

            // Â§ÑÁêÜËá™Âä®Êí≠ÊîæÈÄªËæë
            handleAutoPlay(chunkIndex) {
                console.log(`[AutoPlay] Â§ÑÁêÜÁâáÊÆµ ${chunkIndex}ÔºåÂΩìÂâçÁä∂ÊÄÅ: Êí≠Êîæ=${this.currentPlayingIndex}, Â∫èÂàó=${this.isPlayingSequence}`);
                
                if (this.currentPlayingIndex === -1 && !this.isPlayingSequence) {
                    // ÂΩìÂâçÊ≤°ÊúâÈü≥È¢ëÂú®Êí≠Êîæ‰∏î‰∏çÂú®Êí≠ÊîæÂ∫èÂàó‰∏≠ÔºåÊ£ÄÊü•ÊòØÂê¶Â∫îËØ•ÂºÄÂßãÊí≠Êîæ
                    if (chunkIndex === 0 || !this.shouldWaitForEarlierChunks(chunkIndex)) {
                        // Â¶ÇÊûúÊòØÁ¨¨‰∏Ä‰∏™ÁâáÊÆµÔºåÊàñËÄÖÂâçÈù¢ÁöÑÁâáÊÆµÈÉΩÂ∑≤ÂáÜÂ§áÂ•Ω/‰∏çÂ≠òÂú®ÔºåÁõ¥Êé•Êí≠Êîæ
                        console.log(`[AutoPlay] Áõ¥Êé•Êí≠ÊîæÁâáÊÆµ ${chunkIndex}`);
                        this.playChunk(chunkIndex);
                        this.isPlayingSequence = true;
                    } else {
                        // Âê¶ÂàôÂä†ÂÖ•ÈòüÂàóÁ≠âÂæÖ
                        console.log(`[AutoPlay] ÁâáÊÆµ ${chunkIndex} ÈúÄÁ≠âÂæÖÊõ¥Êó©ÁâáÊÆµÔºåÂä†ÂÖ•ÈòüÂàó`);
                        this.addToPlaybackQueue(chunkIndex);
                    }
                } else {
                    // ÊúâÈü≥È¢ëÂú®Êí≠ÊîæÊàñÊ≠£Âú®Êí≠ÊîæÂ∫èÂàó‰∏≠ÔºåÂä†ÂÖ•Êí≠ÊîæÈòüÂàó
                    console.log(`[AutoPlay] ÁâáÊÆµ ${chunkIndex} Âä†ÂÖ•Êí≠ÊîæÈòüÂàó`);
                    this.addToPlaybackQueue(chunkIndex);
                    
                    // Â¶ÇÊûúÂΩìÂâçÊ≤°ÊúâÊ≠£Âú®Êí≠ÊîæÁöÑÈü≥È¢ëÔºå‰ΩÜÊúâÈòüÂàóÔºåÂ∞ùËØïÊí≠ÊîæÈòüÂàó‰∏≠ÁöÑ‰∏ã‰∏Ä‰∏™
                    if (this.currentPlayingIndex === -1 && this.playbackQueue.length > 0) {
                        const nextIndex = this.getNextChunkToPlay();
                        if (nextIndex !== -1) {
                            console.log(`[AutoPlay] ‰ªéÈòüÂàóÊí≠ÊîæÁâáÊÆµ ${nextIndex}`);
                            this.playbackQueue.splice(this.playbackQueue.indexOf(nextIndex), 1);
                            this.playChunk(nextIndex);
                        }
                    }
                }
            }

            // Ê£ÄÊü•ÊòØÂê¶Â∫îËØ•Á≠âÂæÖÊõ¥Êó©ÁöÑÁâáÊÆµ
            shouldWaitForEarlierChunks(chunkIndex) {
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÊõ¥Êó©ÁöÑÁâáÊÆµËøòÊ≤°ÊúâÁîüÊàêÂÆåÊàê
                for (let i = 0; i < chunkIndex; i++) {
                    // Â¶ÇÊûúÊüê‰∏™Êõ¥Êó©ÁöÑÁâáÊÆµÂ≠òÂú®‰ΩÜËøòÊ≤°ÊúâÈü≥È¢ëÊï∞ÊçÆÔºåÈúÄË¶ÅÁ≠âÂæÖ
                    const chunkElement = document.getElementById(`chunk-${i}`);
                    if (chunkElement && !this.audioQueue[i]) {
                        return true;
                    }
                }
                return false;
            }

            // Ëé∑Âèñ‰∏ã‰∏Ä‰∏™Â∫îËØ•Êí≠ÊîæÁöÑÁâáÊÆµ
            getNextChunkToPlay() {
                if (this.playbackQueue.length === 0) return -1;
                
                // ÊâæÂà∞ÈòüÂàó‰∏≠ÊúÄÂ∞èÁöÑÁ¥¢ÂºïÔºàÊúÄÊó©ÁöÑÁâáÊÆµÔºâ
                return Math.min(...this.playbackQueue);
            }

            // Ê∑ªÂä†Âà∞Êí≠ÊîæÈòüÂàó
            addToPlaybackQueue(chunkIndex) {
                if (!this.playbackQueue.includes(chunkIndex)) {
                    // ÊåâÈ°∫Â∫èÊèíÂÖ•ÈòüÂàóÔºåÁ°Æ‰øùÊí≠ÊîæÈ°∫Â∫èÊ≠£Á°Æ
                    let insertIndex = 0;
                    while (insertIndex < this.playbackQueue.length && this.playbackQueue[insertIndex] < chunkIndex) {
                        insertIndex++;
                    }
                    this.playbackQueue.splice(insertIndex, 0, chunkIndex);
                    this.updateQueueStatus();
                }
            }

            // Êõ¥Êñ∞ÈòüÂàóÁä∂ÊÄÅÊòæÁ§∫
            updateQueueStatus() {
                if (this.playbackQueue.length > 0) {
                    this.queueStatus.style.display = 'block';
                    this.queueCount.textContent = this.playbackQueue.length;
                } else {
                    this.queueStatus.style.display = 'none';
                }
            }

            playAllChunks() {
                if (this.audioQueue.length === 0) {
                    return;
                }

                this.pauseAllChunks();
                
                // ÈáçÁΩÆÊí≠ÊîæÈòüÂàó
                this.playbackQueue = [];
                this.isPlayingSequence = true;
                
                // ÊûÑÂª∫ÂÆåÊï¥ÁöÑÊí≠ÊîæÈòüÂàóÔºå‰ªéÁ¨¨‰∫å‰∏™ÂºÄÂßãÔºàÁ¨¨‰∏Ä‰∏™‰ºöÁõ¥Êé•Êí≠ÊîæÔºâ
                for (let i = 1; i < this.audioQueue.length; i++) {
                    if (this.audioQueue[i]) {
                        this.playbackQueue.push(i);
                    }
                }
                
                this.updateQueueStatus();
                
                // ÂºÄÂßãÊí≠ÊîæÁ¨¨‰∏Ä‰∏™
                if (this.audioQueue[0]) {
                    this.playChunk(0);
                } else {
                    // Â¶ÇÊûúÁ¨¨‰∏Ä‰∏™ÁâáÊÆµ‰∏çÂ≠òÂú®Ôºå‰ªéÈòüÂàó‰∏≠Êí≠ÊîæÁ¨¨‰∏Ä‰∏™ÂèØÁî®ÁöÑ
                    if (this.playbackQueue.length > 0) {
                        const firstIndex = this.playbackQueue.shift();
                        this.updateQueueStatus();
                        this.playChunk(firstIndex);
                    }
                }
            }

            // Âè™ÂÅúÊ≠¢Èü≥È¢ëÊí≠ÊîæÔºå‰∏çÈáçÁΩÆÊí≠ÊîæÁä∂ÊÄÅÔºàÁî®‰∫éÂàáÊç¢Èü≥È¢ëÊó∂Ôºâ
            pauseAllAudioOnly() {
                this.audioQueue.forEach((audioInfo, index) => {
                    if (audioInfo && audioInfo.audio) {
                        audioInfo.audio.pause();
                        audioInfo.audio.currentTime = 0;
                        // Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÈÅøÂÖçÊí≠ÊîæÂÆåÊàê‰∫ã‰ª∂Ëß¶Âèë
                        audioInfo.audio.onended = null;
                    }
                });
            }

            // ÂÅúÊ≠¢ÊâÄÊúâÈü≥È¢ëÂπ∂ÈáçÁΩÆÊí≠ÊîæÁä∂ÊÄÅÔºàÁî®‰∫éÂÆåÂÖ®ÂÅúÊ≠¢Êí≠ÊîæÔºâ
            pauseAllChunks() {
                this.pauseAllAudioOnly();
                
                // ÈáçÁΩÆÊí≠ÊîæÁä∂ÊÄÅ
                this.currentPlayingIndex = -1;
                this.isPlayingSequence = false;
                this.playbackQueue = [];
                this.updateQueueStatus();
            }

            stopStreaming() {
                this.isStreaming = false;
                this.statusText.textContent = '‚èπÔ∏è Â∑≤ÂÅúÊ≠¢ÁîüÊàê';
                this.updateButtonStates(false);
                this.pauseAllChunks();
            }

            resetState() {
                this.audioChunks = [];
                this.audioQueue = [];
                this.totalSize = 0;
                this.currentPlayingIndex = -1;
                
                // ÈáçÁΩÆÁªüËÆ°‰ø°ÊÅØ
                this.totalChunksSpan.textContent = '0';
                this.completedChunksSpan.textContent = '0';
                this.totalTimeSpan.textContent = '0s';
                this.totalSizeSpan.textContent = '0KB';
                
                // ÈáçÁΩÆËøõÂ∫¶Êù°
                this.progressBar.style.width = '0%';
                
                // ÈáçÁΩÆ‰∏ãËΩΩÊåâÈíÆ
                this.downloadBtn.disabled = true;
                this.downloadBtn.textContent = 'üíæ ‰∏ãËΩΩÂêàÊàêÈü≥È¢ë';
                
                // Ê∏ÖÁ©∫ÁâáÊÆµÂÆπÂô®
                this.chunksContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: #6c757d;">üéµ Èü≥È¢ëÁâáÊÆµÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫</div>';
            }

            // ‰∏ãËΩΩÂêàÂπ∂ÂêéÁöÑÈü≥È¢ë
            async downloadMergedAudio() {
                if (this.audioQueue.length === 0) {
                    alert('Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑÈü≥È¢ëÁâáÊÆµ');
                    return;
                }

                try {
                    this.downloadBtn.disabled = true;
                    this.downloadBtn.textContent = 'üîÑ ÂêàÂπ∂‰∏≠...';
                    
                    // Ëé∑ÂèñÊâÄÊúâÊúâÊïàÁöÑÈü≥È¢ëÁâáÊÆµ
                    const validAudioChunks = [];
                    for (let i = 0; i < this.audioQueue.length; i++) {
                        if (this.audioQueue[i] && this.audioQueue[i].blob) {
                            validAudioChunks.push(this.audioQueue[i].blob);
                        }
                    }

                    if (validAudioChunks.length === 0) {
                        alert('Ê≤°ÊúâÊúâÊïàÁöÑÈü≥È¢ëÁâáÊÆµÂèØ‰∏ãËΩΩ');
                        return;
                    }

                    // ÂêàÂπ∂Èü≥È¢ëÊï∞ÊçÆ
                    const mergedAudio = await this.mergeAudioBlobs(validAudioChunks);
                    
                    // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                    const url = URL.createObjectURL(mergedAudio);
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                    const filename = `tts_merged_audio_${timestamp}.wav`;
                    
                    // Ëß¶Âèë‰∏ãËΩΩ
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    downloadLink.download = filename;
                    downloadLink.style.display = 'none';
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    
                    // Ê∏ÖÁêÜ‰∏¥Êó∂URL
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                    
                    this.statusText.textContent = `‚úÖ Èü≥È¢ë‰∏ãËΩΩÂÆåÊàê: ${filename}`;
                    
                } catch (error) {
                    console.error('‰∏ãËΩΩÈü≥È¢ëÂ§±Ë¥•:', error);
                    alert('‰∏ãËΩΩÈü≥È¢ëÊó∂ÂèëÁîüÈîôËØØ: ' + error.message);
                } finally {
                    this.downloadBtn.disabled = false;
                    this.downloadBtn.textContent = 'üíæ ‰∏ãËΩΩÂêàÊàêÈü≥È¢ë';
                }
            }

            // ÂêàÂπ∂Â§ö‰∏™Èü≥È¢ëBlob
            async mergeAudioBlobs(audioBlobs) {
                // ÂàõÂª∫Èü≥È¢ë‰∏ä‰∏ãÊñá
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const audioBuffers = [];
                
                // Ëß£Á†ÅÊâÄÊúâÈü≥È¢ëÊï∞ÊçÆ
                for (const blob of audioBlobs) {
                    try {
                        const arrayBuffer = await blob.arrayBuffer();
                        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                        audioBuffers.push(audioBuffer);
                    } catch (error) {
                        console.warn('Ëß£Á†ÅÈü≥È¢ëÂ§±Ë¥•ÔºåË∑≥ËøáËØ•ÁâáÊÆµ:', error);
                    }
                }

                if (audioBuffers.length === 0) {
                    throw new Error('Ê≤°ÊúâÊúâÊïàÁöÑÈü≥È¢ëÊï∞ÊçÆÂèØÂêàÂπ∂');
                }

                // ËÆ°ÁÆóÂêàÂπ∂ÂêéÁöÑÊÄªÈïøÂ∫¶
                const totalLength = audioBuffers.reduce((sum, buffer) => sum + buffer.length, 0);
                const sampleRate = audioBuffers[0].sampleRate;
                const numberOfChannels = audioBuffers[0].numberOfChannels;

                // ÂàõÂª∫ÂêàÂπ∂ÂêéÁöÑÈü≥È¢ëÁºìÂÜ≤Âå∫
                const mergedBuffer = audioContext.createBuffer(numberOfChannels, totalLength, sampleRate);

                // ÂêàÂπ∂Èü≥È¢ëÊï∞ÊçÆ
                let offset = 0;
                for (const buffer of audioBuffers) {
                    for (let channel = 0; channel < numberOfChannels; channel++) {
                        const channelData = buffer.getChannelData(channel);
                        mergedBuffer.getChannelData(channel).set(channelData, offset);
                    }
                    offset += buffer.length;
                }

                // Â∞ÜÈü≥È¢ëÁºìÂÜ≤Âå∫ËΩ¨Êç¢‰∏∫WAVÊ†ºÂºèÁöÑBlob
                const wavBlob = this.audioBufferToWav(mergedBuffer);
                
                // ÂÖ≥Èó≠Èü≥È¢ë‰∏ä‰∏ãÊñá
                await audioContext.close();
                
                return wavBlob;
            }

            // Â∞ÜAudioBufferËΩ¨Êç¢‰∏∫WAVÊ†ºÂºèÁöÑBlob
            audioBufferToWav(buffer) {
                const length = buffer.length;
                const numberOfChannels = buffer.numberOfChannels;
                const sampleRate = buffer.sampleRate;
                const bytesPerSample = 2; // 16-bit
                const blockAlign = numberOfChannels * bytesPerSample;
                const byteRate = sampleRate * blockAlign;
                const dataSize = length * blockAlign;
                const bufferSize = 44 + dataSize;

                const arrayBuffer = new ArrayBuffer(bufferSize);
                const view = new DataView(arrayBuffer);

                // WAVÊñá‰ª∂Â§¥
                const writeString = (offset, string) => {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                };

                // RIFFÊ†áËØÜÁ¨¶
                writeString(0, 'RIFF');
                view.setUint32(4, bufferSize - 8, true);
                writeString(8, 'WAVE');

                // fmtÂ≠êÂùó
                writeString(12, 'fmt ');
                view.setUint32(16, 16, true); // Â≠êÂùóÂ§ßÂ∞è
                view.setUint16(20, 1, true); // Èü≥È¢ëÊ†ºÂºè (PCM)
                view.setUint16(22, numberOfChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, byteRate, true);
                view.setUint16(32, blockAlign, true);
                view.setUint16(34, 16, true); // ‰ΩçÊ∑±Â∫¶

                // dataÂ≠êÂùó
                writeString(36, 'data');
                view.setUint32(40, dataSize, true);

                // Èü≥È¢ëÊï∞ÊçÆ
                let offset = 44;
                for (let i = 0; i < length; i++) {
                    for (let channel = 0; channel < numberOfChannels; channel++) {
                        const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
                        const intSample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                        view.setInt16(offset, intSample, true);
                        offset += 2;
                    }
                }

                return new Blob([arrayBuffer], { type: 'audio/wav' });
            }

            updateButtonStates(isStreaming) {
                this.startBtn.disabled = isStreaming;
                this.stopBtn.disabled = !isStreaming;
                this.playAllBtn.disabled = isStreaming;
                this.pauseAllBtn.disabled = isStreaming;
                this.downloadBtn.disabled = isStreaming; // ÁîüÊàêËøáÁ®ã‰∏≠Á¶ÅÁî®‰∏ãËΩΩ
            }

            base64ToArrayBuffer(base64) {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            }
        }

        // ÂàùÂßãÂåñÂÆ¢Êà∑Á´Ø
        const client = new StreamingTTSClient();

        // Á§∫‰æãÊñáÊú¨
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('textInput').value = `ÂêÑ‰ΩçÂ™í‰ΩìÊúãÂèã„ÄÅÂ∏ÇÊ∞ë‰ª£Ë°®Ôºö‚Äã
Â§ßÂÆ∂‰∏äÂçàÂ•ΩÔºÅ‰ªäÂ§©ÔºåÊàë‰ª¨ÊÄÄÁùÄÊ¨£ÂñúÁöÑÂøÉÊÉÖÔºåÂêëÁ§æ‰ºöÊ≠£ÂºèÂÆ£Â∏ÉÊàëÂ∏ÇÊô∫ÊÖß‰∫§ÈÄöÁ≥ªÁªüÂÖ®Èù¢ÂçáÁ∫ß‰∏äÁ∫ø„ÄÇËøôÊòØÊàëÂ∏ÇËêΩÂÆû ‚ÄúÊô∫ÊÖßÂüéÂ∏Ç‚Äù Âª∫ËÆæËßÑÂàíÁöÑÂÖ≥ÈîÆ‰∏ÄÊ≠•Ôºå‰πüÊòØËß£ÂÜ≥Â∏ÇÊ∞ëÂá∫Ë°åÁóõÁÇπ„ÄÅÊèêÂçáÂüéÂ∏ÇÊ≤ªÁêÜÊïàËÉΩÁöÑÈáçË¶Å‰∏æÊé™„ÄÇ‚Äã
Ê≠§Ê¨°ÂçáÁ∫ßÂéÜÊó∂ 18 ‰∏™ÊúàÔºåÁî±Â∏Ç‰∫§ÈÄöÂ±ÄËÅîÂêàÁßëÊäÄ‰ºÅ‰∏öÂÖ±ÂêåÁ†îÂèëÔºåÊï¥Âêà‰∫ÜÂ§ßÊï∞ÊçÆ„ÄÅ‰∫∫Â∑•Êô∫ËÉΩ„ÄÅ5G Á≠âÂâçÊ≤øÊäÄÊúØÔºåÂΩ¢Êàê ‚Äú‰∏ÄÂπ≥Âè∞„ÄÅÂ§öÂú∫ÊôØ‚Äù ÁöÑÊúçÂä°‰ΩìÁ≥ª„ÄÇÂπ≥Âè∞Ê†∏ÂøÉÂäüËÉΩÊ∂µÁõñ‰∏âÂ§ßÊùøÂùóÔºö‰∏ÄÊòØÂÆûÊó∂Ë∑ØÂÜµÊô∫ËÉΩÈ¢ÑË≠¶ÔºåÈÄöËøáÈÅçÂ∏ÉÂüéÂå∫ÁöÑ 500 ‰ΩôÂ§ÑÊô∫ËÉΩÁõëÊµãËÆæÂ§áÔºåÂÆûÊó∂ÊçïÊçâ‰∫§ÈÄöÊã•Â†µ„ÄÅ‰∫ãÊïÖÁ≠âÂºÇÂ∏∏ÊÉÖÂÜµÔºå10 ÁßíÂÜÖÊé®ÈÄÅÈ¢ÑË≠¶‰ø°ÊÅØËá≥Âë®ËæπËΩ¶ËæÜÔºõ‰∫åÊòØÂÖ¨ÂÖ±‰∫§ÈÄöÁ≤æÂáÜË∞ÉÂ∫¶ÔºåÂ∏ÇÊ∞ëÈÄöËøá ‚ÄúÂüéÂ∏ÇÂá∫Ë°å‚Äù APPÔºåÂèØÊü•ËØ¢ÂÖ¨‰∫§„ÄÅÂú∞ÈìÅÁöÑÂÆûÊó∂‰ΩçÁΩÆÔºåÈ¢Ñ‰º∞Âà∞Á´ôÊó∂Èó¥ËØØÂ∑ÆÁº©Â∞èËá≥ 1 ÂàÜÈíüÂÜÖÔºõ‰∏âÊòØÂÅúËΩ¶ËµÑÊ∫êÈ´òÊïàÂà©Áî®ÔºåÁ≥ªÁªüÊï¥ÂêàÂÖ®Â∏Ç 2.3 ‰∏á‰∏™ÂÖ¨ÂÖ±ÂÅúËΩ¶‰Ωç‰ø°ÊÅØÔºåÊîØÊåÅÂú®Á∫øÈ¢ÑÁ∫¶„ÄÅÊó†ÊÑüÊîØ‰ªòÔºåÊúâÊïàÁºìËß£ ‚ÄúÂÅúËΩ¶Èöæ‚Äù ÈóÆÈ¢ò„ÄÇ‚Äã
ËØïËøêË°å‰∏Ä‰∏™Êúà‰ª•Êù•ÔºåÁ≥ªÁªüÂ∑≤Ë¶ÜÁõñ‰∏ªÂüéÂå∫ 80% ÁöÑ‰∫§ÈÄöË∑ØÁΩëÔºåÈ´òÂ≥∞Êó∂ÊÆµÈÅìË∑ØÈÄöË°åÊïàÁéáÊèêÂçá 25%ÔºåÂÖ¨ÂÖ±‰∫§ÈÄöÂáÜÁÇπÁéáÊèêÈ´òËá≥ 98%ÔºåÂ∏ÇÊ∞ëÊª°ÊÑèÂ∫¶Ëææ 92%„ÄÇ‰∏ã‰∏ÄÊ≠•ÔºåÊàë‰ª¨Â∞ÜÈÄêÊ≠•ÊãìÂ±ïÂéøÂüü‰∫§ÈÄöË¶ÜÁõñËåÉÂõ¥ÔºåËÆ°ÂàíÂπ¥ÂÜÖÊñ∞Â¢û 100 Â§ÑÊô∫ËÉΩËøáË°óËÆæÂ§á„ÄÅ50 Êù°ÂÆöÂà∂ÂÖ¨‰∫§Ë∑ØÁ∫øÔºåÊåÅÁª≠‰ºòÂåñÊô∫ÊÖß‰∫§ÈÄöÊúçÂä°‰ΩìÈ™å„ÄÇ‚Äã
‰∫§ÈÄöÊòØÂüéÂ∏ÇÁöÑ ‚ÄúË°ÄËÑâ‚ÄùÔºåÊô∫ÊÖß‰∫§ÈÄöÁ≥ªÁªüÁöÑÂçáÁ∫ßÔºåÊó¢ÊòØÊèêÂçáÂüéÂ∏ÇÁ´û‰∫âÂäõÁöÑÂøÖÁÑ∂ÈÄâÊã©ÔºåÊõ¥ÊòØ‰∏∫Â∏ÇÊ∞ëÂàõÈÄ†ÁæéÂ•ΩÁîüÊ¥ªÁöÑÂÖ∑‰ΩìÂÆûË∑µ„ÄÇÊàë‰ª¨ÊúüÂæÖ‰∏éÁ§æ‰ºöÂêÑÁïåÂÖ±ÂêåÁõëÁù£„ÄÅÂª∫Ë®ÄÁåÆÁ≠ñÔºåËÆ©Êô∫ÊÖß‰∫§ÈÄöÁúüÊ≠£Êàê‰∏∫‰æøÊ∞ë„ÄÅÂà©Ê∞ë„ÄÅÊÉ†Ê∞ëÁöÑÊ∞ëÁîüÂ∑•Á®ãÔºÅ‚Äã
Ë∞¢Ë∞¢Â§ßÂÆ∂ÔºÅ`;
            
            // Êõ¥Êñ∞Â≠óÁ¨¶ËÆ°Êï∞
            client.charCountSpan.textContent = document.getElementById('textInput').value.length;
        });
    </script>
</body>
</html>
